# LedgerAlpha 循环迭代记录 (Round 4)

## 1. 深度自我反思 (第 501-600 次迭代)
- **单进程架构瓶颈**：目前采集器、对账引擎等都是独立运行的零散脚本，缺乏一个统一的“系统守护进程 (Master Daemon)”进行调度与资源管理。
- **采集器 I/O 开销过大**：`collector.py` 每次处理文件都计算全文 MD5，对于大型发票扫描件或视频凭证，高频的全文哈希会造成不必要的磁盘 I/O 峰值。
- **服务健康监控缺失**：当某个 Agent 发生 API 超时或 key 失效时，目前只是在日志里记录 `error`，没有实时的“健康心跳”反馈给外部监控系统。
- **数据库连接复用率低**：虽然使用了单例模式，但 `transaction` 上下文每次都执行 `connect/close`。在高频并发场景下，SQLite 的 `WAL` (Write-Ahead Logging) 模式配合持久连接性能更优。
- **交互流程逻辑闭环不全**：`interaction_hub.py` 目前仅实现了模拟推送。若用户点击“拒绝”，系统目前缺乏真正的数据库“记账标记拦截”或“冲销”动作。

---

## 2. 确定的 5 个优化点
1. **主守护进程化 (Master Daemon)**：编写 `main.py`，使用 `multiprocessing` 或 `subprocess` 统一拉起并监控所有子服务，支持优雅退出信号处理。
2. **基于块读取的快速指纹算法**：优化 `utils.py` 中的哈希计算。改为“文件大小 + 头尾 8KB 采样哈希”作为快速判重标识，仅在冲突时执行全量哈希。
3. **服务心跳状态同步表**：在 `DBHelper` 中新增 `sys_status` 表，各子服务每 10s 更新一次心跳，实现应用级的自监控。
4. **SQLite WAL 模式强制开启**：在 `DBHelper` 初始化时显式配置 `PRAGMA journal_mode=WAL`，大幅提升读写并发性能。
5. **交互逻辑闭环整改**：升级 `interaction_hub.py`，支持 `REJECT` 操作自动将数据库记录标记为 `BLOCKED`，防止异常单据反复进入审计流。

---

## 3. 整改实施
- [x] 编写 `src/main.py` 实现 Master 调度。
- [x] 优化哈希算法，引入 Fast Hash 逻辑。
- [x] 在 `db_helper.py` 中增加心跳表与心跳更新方法。
- [x] 在数据库连接逻辑中强制开启 WAL。
- [x] 闭环交互中心的拒绝/阻断逻辑。

---
*注：本轮优化完成，即将触发下一轮循环。迭代进度：4/10。*
