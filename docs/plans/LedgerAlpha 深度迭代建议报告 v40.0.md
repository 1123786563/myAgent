# LedgerAlpha 深度迭代建议报告 v40.0

## 1. 深度反思与现状评估
LedgerAlpha 系统已通过 39 轮迭代构建了涵盖采集、记账、审计、税务巡检及交互回流的完整链路。当前系统在功能深度和自动化闭环上已初具规模，但在应对复杂合规环境、数据深挖及架构自愈能力上仍有以下待提升点：
- **税务哨兵深度不足 (F3.3.1)**：`SentinelAgent` 目前仅支持简单的税负率和关键字校验，缺乏对“金税四期”核心的“公转私”异常监控及“长期零申报”逻辑模拟。
- **供应商洞察算法缺失 (F3.3.5)**：详细设计中提到的 `Historical Price Clustering` 算法尚未在 `sentinel_agent.py` 或其他模块中真正落地，导致无法预警供应商价格异常波动。
- **数据库自愈与健康监控 (Reliability)**：`DBHelper` 虽然有了事务重试，但缺乏针对数据库索引退化或关键配置丢失的自动化探测与修复逻辑。
- **推理熔断阈值硬编码 (Non-Functional 4.2)**：目前的成本控制逻辑散落在各 Agent 中，缺乏一个统一的 `InferenceQuotaManager` 来实现全系统的 Token/时延熔断。
- **IM 决策的二级确认机制 (F3.4.1)**：对于高风险操作（如 `BLOCK` 或大额修正），目前是一次性回调，缺乏针对极端重要指令的二级行政确认流程（双人授权雏形）。

## 2. 五项优化建议

### 建议 1：升级 `SentinelAgent` 实现“公转私”与“价格聚类”监控 (F3.3.5)
- **目标**：落地供应商价格波动预警与敏感支付巡检。
- **动作**：在 `sentinel_agent.py` 中实装历史价格聚类逻辑，并增加对个人收款方（公转私）的风险扫描。

### 建议 2：实现 `InferenceQuotaManager` 统一成本熔断 (Non-Functional 4.2)
- **目标**：集中管控全系统的 AI 推理成本，防止 Token 爆炸。
- **动作**：新建 `src/quota_manager.py`，记录各 trace_id 的累计消耗，并在超限时强制降级。

### 3. 建议 3：增强 `DBHelper` 的“自维护”健康检查逻辑
- **目标**：确保数据库在高并发运行后的索引效率与完整性。
- **动作**：扩展 `_daily_maintenance`，增加 `ANALYZE` 统计信息更新及索引碎片自动 `REINDEX` 的雏形。

### 4. 建议 4：完善 `InteractionHub` 的“双人授权”交互逻辑 (F3.4.1)
- **目标**：应对详细设计中提到的“会计红线阻断”强制人工干预。
- **动作**：支持在推送卡片时标记 `requires_dual_auth`，回调时需匹配两个不同的 `operator`。

### 5. 建议 5：实装 `Exporter` 的“模拟报税”沙箱导出 (F3.3.2)
- **目标**：生成符合税务局格式的模拟申报表供预览。
- **动作**：在 `exporter.py` 中增加 `tax_sandbox_report` 导出模版，集成 `SentinelAgent` 的计算结果。

---

## 3. 本轮执行计划 (Round 40)
1. **重构 `src/sentinel_agent.py`**：实装历史价格聚类分析（Vendor Intelligence）逻辑。
2. **优化 `src/db_helper.py`**：增加数据库统计信息更新（ANALYZE）与健康指标上报逻辑。
3. **记录变更至 `docs/plans/优化迭代记录_Round40.md`**。
