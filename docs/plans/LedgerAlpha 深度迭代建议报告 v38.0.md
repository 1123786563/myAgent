# LedgerAlpha 深度迭代建议报告 v38.0

## 1. 深度反思与现状评估
在第 37 轮迭代中，我们强化了采集系统的鲁棒性与数据库并发稳定性。目前系统已经构建了从采集到审计、再到反馈的完整自动化闭环。然而，在“人机协作（HITL）”的交互质量与隐私合规的精细化控制上，仍存在以下待优化空间：
- **IM 决策卡片交互单一 (F3.4.1)**：目前的 `InteractionHub` 仅支持简单的脱敏推送与二元（CONFIRM/REJECT）回调，缺乏针对“影子分录”多条目合并确认、修改科目后入账等复杂场景的支持。
- **脱敏策略粒度较粗 (F4.1)**：`PrivacyGuard` 虽然有角色区分，但脱敏逻辑硬编码较多，无法根据不同的 IM 平台（如微信与飞书的安全级别差异）或特定的业务场景进行动态分级。
- **HITL 决策后的知识反哺不足 (F3.4.2)**：老板在 IM 端的“CONFIRM”或“修正入账”动作，目前仅更新了分录状态，尚未自动触发 `KnowledgeBridge` 将该正确决策沉淀为高置信度的 `MANUAL` 规则。
- **回调接口安全性单一 (F4.1)**：虽然有签名校验，但缺乏针对回调频率、IP 白名单及一次性令牌（Nonce）的综合防御，面临重放攻击风险。
- **缺乏批量消消乐交互 (F3.1.2)**：对账引擎产生的“影子匹配”结果缺乏一个批量展现与一键确认的 IM 界面，容易造成交互疲劳。

## 2. 五项优化建议

### 建议 1：升级 `InteractionHub` 支持“多维决策卡片” (F3.4.1)
- **目标**：让老板不仅能确认，还能在手机端直接修正科目或打标签。
- **动作**：扩展 `push_card` 与 `handle_callback`，支持包含 `updated_category` 和 `selected_tags` 的复杂回调负载。

### 建议 2：实现 IM 端的“知识回流”自动化 (F3.4.2)
- **目标**：当老板手动修正并确认分录时，自动将该知识点沉淀。
- **动作**：在 `handle_callback` 中，若检测到手动修正，自动调用 `KnowledgeBridge.learn_new_rule` 并标记来源为 `MANUAL`。

### 建议 3：精细化 `PrivacyGuard` 的“场景化脱敏” (F4.1)
- **目标**：支持针对特定单据类型（如薪资单）执行最高等级脱敏。
- **动作**：扩展 `desensitize` 接口，支持基于 `data_type` 的多级脱敏模版。

### 4. 建议 4：增强回调接口的防御纵深 (Security)
- **目标**：防止重放攻击与非法篡改。
- **动作**：在 `handle_callback` 中引入 `nonce` 校验，并在 `InteractionHub` 增加基于 Redis 或本地 Cache 的一次性令牌检查。

### 5. 建议 5：构建“对账消消乐”批量汇总卡片 (F3.1.2)
- **目标**：提升批量对账的交互效率。
- **动作**：实现 `push_batch_reconcile_card`，将多笔影子匹配成功的建议聚合在一个卡片中，支持一键全选或逐条滑动确认。

---

## 3. 本轮执行计划 (Round 38)
1. **重构 `src/interaction_hub.py`**：实现 IM 端的“手动修正”反馈逻辑，并打通 `KnowledgeBridge` 的知识回流。
2. **优化 `src/privacy_guard.py`**：增加基于数据类型的分级脱敏模版。
3. **记录变更至 `docs/plans/优化迭代记录_Round38.md`**。
