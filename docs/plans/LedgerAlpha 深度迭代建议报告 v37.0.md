# LedgerAlpha 深度迭代建议报告 v37.0

## 1. 深度反思与现状评估
在第 36 轮迭代中，我们实装了知识进化的负反馈惩罚与安全同步机制。目前系统在业务处理闭环上已经非常成熟，但在非功能性需求——特别是系统的“鲁棒性”与“并发隔离”上，仍有以下痛点：
- **Collector 的并发异常隔离缺失 (F3.1.1)**：目前的 `CollectorWorker` 在处理文件时，若遇到损坏的 PDF 或超大的 CSV，其异常处理仅停留在 `try-except` 捕获。如果解析过程导致内存溢出或线程死锁，会影响整个 Worker 甚至主进程。
- **解析任务缺乏超时控制**：对于复杂的银行流水解析（`_parse_bank_statement`），如果文件行数达到百万级，会长时间占用 Worker 线程。
- **缺乏多模态资产识别雏形 (F3.1.3)**：虽然需求提到了多模态识别，但目前代码仅支持简单的文件后缀识别，缺乏对“资产照片”进行语义聚合的逻辑框架。
- **影子银企直连的凭据管理缺失 (F3.1.4)**：详细设计中提到凭据应通过加密 Store 注入，但目前的代码库中尚未看到针对 OpenManus 驱动的凭据隔离逻辑。
- **数据库事务重试机制单一 (Non-Functional)**：`DBHelper` 的事务重试仅基于简单的 sleep，在极高并发采集场景下可能导致锁竞争加剧。

## 2. 五项优化建议

### 建议 1：实现 `Collector` 的子任务隔离保护 (Robustness)
- **目标**：防止单个异常文件导致 Worker 挂起。
- **动作**：引入线程池/进程池装饰器，并为 `_process_file` 设置强制超时阈值。

### 建议 2：落地多模态资产识别框架 (F3.1.3)
- **目标**：为后续接入多模态模型（如 Gemini/GPT-4o）识别实物资产预留接口。
- **动作**：在 `Collector` 中增加 `_analyze_multimodal_asset` 逻辑，支持识别同一时间段内的多张照片并聚合。

### 3. 建议 3：强化 `DBHelper` 的指数退避重试 (Reliability)
- **目标**：更优雅地处理 SQLite 数据库死锁。
- **动作**：将 `transaction` 中的 `time.sleep` 改为带有随机抖动的指数退避逻辑。

### 4. 建议 4：完善 `Collector` 的解析性能保障 (Performance)
- **目标**：针对大批量银行流水解析增加分片处理。
- **动作**：在 `_parse_bank_statement` 中引入生成器模式，避免一次性加载大数据量。

### 5. 建议 5：实装凭据隔离与注入框架雏形 (F3.1.4)
- **目标**：为影子银企直连提供安全的账号注入环境。
- **动作**：新建 `src/vault_manager.py`，模拟 1Password/加密 Store 的凭据获取逻辑。

---

## 3. 本轮执行计划 (Round 37)
1. **优化 `src/collector.py`**：引入处理超时控制，并增加多模态资产聚合的逻辑框架。
2. **优化 `src/db_helper.py`**：升级事务重试机制为指数退避。
3. **记录变更至 `docs/plans/优化迭代记录_Round37.md`**。
