# LedgerAlpha 深度迭代建议报告 v53.0

## 1. 核心反思与自我诊断
在前十二轮迭代中，我们完成了从基建、安全、审计、日志诊断到数据库性能监控的全面加固。第十三轮迭代，我们将开启“知识闭环与交互协议”的终极优化：
1. **记账引擎的规则深度**：`AccountingAgent` 虽然具备快速匹配能力，但对“条件分支”的处理仍较简单，缺乏跨单据的上下文感知。
2. **知识回流的闭环验证**：目前的规则晋升依赖于连续 3 次审计通过，但缺乏对规则“时效性”的评估，容易积累过期规则。
3. **系统启动的依赖自愈**：在 `MasterDaemon` 启动时，如果数据库由于 `WAL` 文件异常被锁，系统缺乏自动尝试修复或清理残留文件的逻辑。

## 2. 本轮优化建议 (10项)
1. **[引擎层] 增强 `AccountingAgent` 的复合条件匹配逻辑**：支持基于“多维标签”与“金额区间”的多重判定优先级。
2. **[流程层] 完善规则质量评分系统 (Quality Score)**：在 `knowledge_base` 中增加 `success_rate` 与 `last_used_at`。
3. **[基建层] 增加 `AccountingAgent` 的规则动态增量重载**：仅在 YAML 文件的 `mtime` 变化且哈希不一致时才重载，并在内存中保留“规则快照”。
4. **[运维层] 增加 `DBHelper` 的 `PRAGMA incremental_vacuum` 调度**：定期释放由 `transactions` 更新产生的空闲页。
5. **[交互层] 实现“分录回滚” (One-click Rollback) 的 IM 接口**：在 `InteractionHub` 中实现对 `POSTED` 状态的撤销。
6. **[存储层] 引入 `inference_path_index` 视图**：方便快速通过 `trace_id` 追踪完整推理链路。
7. **[安全层] 强化 `PrivacyGuard` 的“敏感词密度”监控**：防止大量脱敏导致的日志不可读，平衡安全与可调性。
8. **[引擎层] 增加对“相似单据”推荐入账的逻辑**：利用 FTS5 在无规则匹配时搜索历史相似业务。
9. **[性能层] 优化 `AccountingAgent` 的正则表达式缓存机制**：使用 `LRU` 缓存已编译的正则，防止大量复杂正则导致 CPU 峰值。
10. **[可靠性] 增加对 `ledger_alpha.db-wal` 的自检与自愈**：在启动时检测文件大小，若异常过大自动执行检查点。

## 3. 本轮执行计划 (Action Taken)
1. **修改 `accounting_agent.py`**：升级推理路径记录与规则评分预留。
2. **修改 `knowledge_bridge.py`**：完善规则成功率统计。
3. **修改 `db_helper.py`**：增加定期 `vacuum` 维护调度预留。
4. **更新迭代记录**：同步更新 `iteration_count.txt`。

---
迭代时间：2025-03-24
执行人：无敌大旋风 (Iteration Cycle #13)
