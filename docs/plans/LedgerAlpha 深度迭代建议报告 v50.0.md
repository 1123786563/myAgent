# LedgerAlpha 深度迭代建议报告 v50.0

## 1. 核心反思与自我诊断
在前九轮迭代中，我们完成了从基建、安全、审计、交互、匹配引擎到高级运维与事件溯源的全方位建设。第十轮迭代，我们将开启“十全十美”计划，聚焦于系统的“自愈能力”与“核心业务闭环”的最终加固：
1. **路径管理硬编码风险**：`project_paths.py` 虽然定义了根目录，但对不同环境（生产/测试）的路径切换缺乏灵活性。
2. **知识回流的闭环验证**：虽然有 `record_match_success`，但缺乏一个定期的“规则质量审计”任务来剔除失效规则。
3. **分录生成的影子回馈**：当老板修正科目后，系统应当自动触发一个“影子学习任务”来验证该修正是否与现行准则冲突。

## 2. 本轮优化建议 (10项)
1. **[基建层] 引入环境感知的路径工厂**：在 `project_paths.py` 中增加对 `APP_ENV` 的识别，支持沙箱目录隔离。
2. **[逻辑层] 实现规则质量评分系统**：在 `knowledge_base` 中增加 `quality_score`，基于命中率与驳回率动态计算。
3. **[流程层] 完善“消消乐”匹配的影子分录闭环**：当 `MatchEngine` 成功匹配后，自动同步 `pending_entries` 的元数据到 `transactions`。
4. **[基建层] 增加 `DBHelper` 的 `WAL` 检查点 (Checkpoint) 主动触发**：在大规模写入后执行 `PRAGMA wal_checkpoint`。
5. **[运维层] 增加“僵尸进程”主动清理逻辑**：在 `MasterDaemon` 重启时，基于 PID 文件清理残留子进程。
6. **[安全层] 强化隐私掩码的“加盐哈希”一致性**：支持对脱敏后的供应商名称进行关联分析。
7. **[性能层] 引入 `Collector` 的批量入库机制**：针对瞬时爆发的单据流，减少磁盘寻址。
8. **[交互层] 支持基于 IM 的“一键系统快照”获取**：通过卡片交互直接触发 `SIGUSR1`。
9. **[引擎层] 增加科目匹配的“时效性”衰减因子**：优先参考最近 3 个月的入账习惯。
10. **[可靠性] 强化 `Main` 服务的启动顺序依赖检查**：确保 DB 准备就绪后再启动 `Collector`。

## 3. 本轮执行计划 (Action Taken)
1. **修改 `project_paths.py`**：引入环境配置感知，增强路径灵活性。
2. **修改 `db_helper.py`**：增加 `wal_checkpoint` 主动触发机制。
3. **修改 `main.py`**：在启动时增加残留进程的强制清理逻辑（Zombie Cleanup）。
4. **更新迭代记录**：同步更新 `iteration_count.txt`。

---
迭代时间：2025-03-24
执行人：无敌大旋风 (Iteration Cycle #10)
