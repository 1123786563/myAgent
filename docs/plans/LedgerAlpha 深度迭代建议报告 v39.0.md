# LedgerAlpha 深度迭代建议报告 v39.0

## 1. 深度反思与现状评估
在第 38 轮迭代中，我们实现了 IM 知识回流闭环与场景化脱敏。目前，系统的“影子匹配”逻辑已具备初步的并发处理能力，但在“秒级消消乐”的业务体验与复杂对账场景的处理上，仍有以下痛点：
- **匹配策略过于单一 (F3.1.2)**：目前的 `MatchStrategy` 仅支持简单的金额容差与供应商名称模糊匹配，缺乏对“多笔交易对一笔发票”或“一笔交易对多张小额发票”的聚合匹配能力。
- **缺乏批量消消乐的 IM 推送 (F3.4.1)**：`MatchEngine` 成功匹配后仅在后台记录，缺乏将匹配建议批量打包并推送到 `InteractionHub` 供用户一键确认的机制。
- **时间窗口硬编码风险**：匹配的时间窗口（`time_window_days`）目前硬编码为 7 天，在跨月对账或节假日场景下可能导致匹配率下降。
- **缺乏“异常对账”处理机制 (F3.3.5)**：当金额完全一致但供应商不匹配时，系统应能触发 `SentinelAgent` 进行风险判定，而非简单放弃。
- **缺乏对账状态的精细化维护**：`MATCHED` 状态过于笼统，无法区分“自动确认”、“老板确认”与“疑似匹配”三种层级。

## 2. 五项优化建议

### 建议 1：升级 `MatchStrategy` 支持“一合多”聚合匹配 (F3.1.2)
- **目标**：解决“一笔银行支出对应三张打车票”这种典型的微小企业对账场景。
- **动作**：引入滑动窗口子集求和算法（Subset Sum），尝试在 48 小时内寻找多笔单据之和等于单笔影子分录的组合。

### 建议 2：实现 `MatchEngine` 的“批量建议推送” (F3.4.1)
- **目标**：提升交互效率，让老板一次性确认一批匹配。
- **动作**：新增 `push_batch_reconcile_card` 逻辑，每当累积 5 笔以上成功匹配或 1 小时周期到期时，推送聚合卡片。

### 3. 建议 3：引入“疑似匹配”缓冲池 (L1)
- **目标**：对置信度在 0.6-0.8 之间的匹配进行标记。
- **动作**：在 `pending_entries` 表中增加 `SUGGESTED_MATCH` 状态，并允许在 IM 卡片中进行“手动连线”修正。

### 4. 建议 4：联动 `SentinelAgent` 处理供应商冲突 (F3.3.5)
- **目标**：识别“张冠李戴”的报销风险。
- **动作**：当金额精确匹配但供应商完全不同时，强制触发 `SentinelAgent` 巡检，判定是否存在发票冒领。

### 5. 建议 5：优化匹配引擎的动态窗口策略
- **目标**：提升跨月对账成功率。
- **动作**：将 `time_window_days` 改为可配置，并支持根据匹配失败频率动态拉长窗口。

---

## 3. 本轮执行计划 (Round 39)
1. **重构 `src/match_engine.py`**：升级匹配逻辑，增加“批量消消乐”卡片推送逻辑。
2. **优化 `src/interaction_hub.py`**：新增批量确认回调处理接口。
3. **记录变更至 `docs/plans/优化迭代记录_Round39.md`**。
