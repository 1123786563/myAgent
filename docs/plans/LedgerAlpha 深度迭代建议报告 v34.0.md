# LedgerAlpha 深度迭代建议报告 v34.0

## 1. 深度反思与现状评估
系统已在之前的迭代中实现了核心的“影子审计”、“税务哨兵”、“穿透式证据链”以及“多维核算”架构。但在系统层面的闭环与工程健壮性上，仍存在以下优化空间：
- **审计反馈回路缺失 (F3.2.2)**：`AuditorAgent` 的 `REJECT` 结果仅停留在日志和风险知识库更新，未能在业务流程中实现自动化的“入库阻断”或“状态联动”，导致风险分录可能通过其他路径入账。
- **成本与工时统计未闭环 (Non-Functional 4.2)**：`MasterDaemon` 虽然监控了系统性能，但对于核心非功能需求“实时展示 AI 节省的人工工时”尚未在代码中落地统计逻辑。
- **规则冲突解决策略不足 (F3.4.2)**：随着灰度规则的引入，`AccountingAgent` 在面临 `GRAY` 与 `VERIFIED` 规则冲突时，缺乏基于审计权重的动态决策机制。
- **数据一致性风险 (L1)**：部分复杂业务操作（如带标签入库）虽然使用了事务，但缺乏跨表一致性的补偿机制或审计对账逻辑。
- **代码健壮性问题**：`AuditorAgent.py` 中存在变量未定义直接使用的逻辑错误（`decision` 等变量在 `_update_risk_knowledge` 块之外），需要立即修复。

## 2. 五项优化建议

### 建议 1：修复并强化 `AuditorAgent` 的审计闭环 (F3.2.2)
- **目标**：修复逻辑错误，并确保审计结果能直接影响分录在数据库中的最终状态。
- **动作**：修复变量作用域错误，并在 `reply` 结束前确保返回结构包含完整的审计元数据。

### 建议 2：在 `MasterDaemon` 中落地工时节省统计 (Non-Functional 4.2)
- **目标**：实现“AI 节省工时”的实时汇总逻辑。
- **动作**：修改 `MasterDaemon`，周期性查询 `transactions` 表中已处理的单据总数，并按 `Processed_Count * 5min` 计算节省工时，存入 `sys_status`。

### 建议 3：实现 `AccountingAgent` 的“审计权重”动态决策 (F3.4.2)
- **目标**：规则冲突时优先保障合规性。
- **动作**：修改匹配逻辑，当命中多个规则时，对比其 `audit_level`；命中 `GRAY` 规则时自动在返回结果中标记“需加强审计”。

### 建议 4：完善 `DBHelper` 的业务审计视图 (F3.2.4)
- **目标**：提供一键式“穿透溯源”视图。
- **动作**：创建视图（VIEW），聚合 `transactions`、`transaction_tags` 及 `knowledge_base` 信息，方便前端展示证据链。

### 建议 5：增强 `Collector` 的并发异常隔离
- **目标**：防止单个大文件解析崩溃导致整个采集服务挂起。
- **动作**：在流水解析逻辑中增加子进程/线程隔离保护。

---

## 3. 本轮执行计划 (Round 34)
1. **修复并优化 `src/auditor_agent.py`**：修正逻辑错误，补全审计返回逻辑。
2. **优化 `src/main.py` (MasterDaemon)**：集成业务维度的“节省工时”统计逻辑。
3. **记录变更至 `docs/plans/优化迭代记录_Round34.md`**。
